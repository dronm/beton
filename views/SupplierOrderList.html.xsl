<?xml version="1.0" encoding="UTF-8"?><xsl:stylesheet version="1.0"  xmlns:html="http://www.w3.org/TR/REC-html40" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:fo="http://www.w3.org/1999/XSL/Format"><xsl:output method="html"/> <xsl:key name="shifts" match="row" use="shift/."/><xsl:key name="suppliers" match="row" use="supplier_id/."/><xsl:key name="shifts_suppliers" match="row" use="concat(shift/.,'|',supplier_id/.)"/><xsl:template name="format_quant">	<xsl:param name="val"/>	<xsl:choose>		<xsl:when test="number($val)=0 or $val=''">			<xsl:text>&#160;</xsl:text>		</xsl:when>		<xsl:otherwise>			<xsl:value-of select="format-number($val,'###,###.00')"/>		</xsl:otherwise>			</xsl:choose>	</xsl:template><!-- Main template--><xsl:template match="/">	<xsl:choose>		<xsl:when test="not(document/model[@id='ModelServResponse']/row[1]/result='0')">		<xsl:apply-templates select="document/model[@id='ModelServResponse']"/>			</xsl:when>		<xsl:otherwise>			<xsl:apply-templates select="document/model[@id='supplier_orders_list']"/>			</xsl:otherwise>	</xsl:choose></xsl:template><!-- Error --><xsl:template match="model[@id='ModelServResponse']">	<div class="error">		<xsl:value-of select="row[1]/descr"/>	</div></xsl:template><!-- table --><xsl:template match="model">	<xsl:variable name="model_id" select="@id"/>		<table id="{$model_id}" class="table table-bordered table-responsive table-striped">		<thead>			<tr>				<th rowspan="2">Смена</th>				<xsl:for-each select="//row[generate-id() =				generate-id(key('suppliers',supplier_id/.)[1])]">									<xsl:sort select="supplier_descr/."/>					<th align="center" colspan="4">						<xsl:value-of select="supplier_descr"/>						<div><xsl:value-of select="number(supplier_proc_rate)*100"/>%						</div>					</th>				</xsl:for-each>							</tr>			<tr>				<xsl:for-each select="//row[generate-id() =				generate-id(key('suppliers',supplier_id/.)[1])]">								<th>Заявлено</th>				<th>SMS</th>				<th>Приход</th>				<th>Сальдо</th>				</xsl:for-each>			</tr>		</thead>		<tbody>		<xsl:for-each select="//row[generate-id() =		generate-id(key('shifts',shift/.)[1])]">			<xsl:variable name="shift" select="shift/."/>						<xsl:variable name="row_class">				<xsl:choose>					<xsl:when test="position() mod 2">odd</xsl:when>					<xsl:otherwise>even</xsl:otherwise>																	</xsl:choose>			</xsl:variable>			<tr class="{$row_class}">				<td class="shift" align="center"><xsl:value-of select="shift_descr"/></td>								<xsl:for-each select="//row[generate-id() =				generate-id(key('suppliers',supplier_id/.)[1])]">					<xsl:sort select="supplier_descr/."/>									<xsl:variable name="supplier_row" select="key('shifts_suppliers',concat($shift,'|',supplier_id/.))"/>										<xsl:variable name="post_class">						<xsl:choose>							<xsl:when test="position() mod 2">post_odd</xsl:when>							<xsl:otherwise>post_even</xsl:otherwise>						</xsl:choose>					</xsl:variable>										<!-- Заявлено -->					<td class="{$post_class}" align="right">					<xsl:call-template name="format_quant">						<xsl:with-param name="val" select="$supplier_row/quant_to_order/."/>					</xsl:call-template>					</td>													<!-- SMS -->					<td class="{$post_class}" align="center">					<xsl:choose>						<xsl:when test="$supplier_row/sms_delivered/.='true'">						<span class="glyphicon glyphicon-ok"/>												</xsl:when>						<xsl:when test="$supplier_row/sms_delivered/.='false'">						<span class="glyphicon glyphicon-minus"/>						</xsl:when>												<xsl:otherwise>						</xsl:otherwise>					</xsl:choose>					</td>													<!-- Факт приход -->					<td class="{$post_class}" align="right">					<xsl:call-template name="format_quant">						<xsl:with-param name="val" select="$supplier_row/quant_procur/."/>					</xsl:call-template>					</td>								<!-- Разница -->					<td class="{$post_class}" align="right">					<xsl:call-template name="format_quant">						<xsl:with-param name="val" select="$supplier_row/quant_balance/."/>					</xsl:call-template>					</td>															</xsl:for-each>			</tr>				</xsl:for-each>		</tbody>		<tfoot>			<tr class="grid_foot">				<td>Итого</td>				<xsl:for-each select="//row[generate-id() =				generate-id(key('suppliers',supplier_id/.)[1])]">								<xsl:sort select="supplier_descr/."/>				<td align="right">					<xsl:call-template name="format_quant">						<xsl:with-param name="val" select="sum(key('suppliers',supplier_id/.)/quant_to_order/.)"/>					</xsl:call-template>								</td>				<td><xsl:text>&#160;</xsl:text></td>								<td align="right">					<xsl:call-template name="format_quant">						<xsl:with-param name="val" select="sum(key('suppliers',supplier_id/.)/quant_procur/.)"/>					</xsl:call-template>												</td>				<td align="right">					<xsl:call-template name="format_quant">						<xsl:with-param name="val" select="sum(key('suppliers',supplier_id/.)/quant_balance/.)"/>					</xsl:call-template>																</td>				</xsl:for-each>							</tr>		</tfoot>	</table></xsl:template></xsl:stylesheet>